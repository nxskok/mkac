<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mann-Kendall correlation and Theil-Sen slope for possibly autocorrelated time series • mkac</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Mann-Kendall correlation and Theil-Sen slope for possibly autocorrelated time series">
<meta property="og:description" content="A re-do of part of the fume package to be (hopefully) feasible for larger data sets.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">mkac</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    

    
    
<!-- README.md is generated from README.Rmd. Please edit that file -->
<div id="mkac" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#mkac" class="anchor"></a>mkac</h1></div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the released version of mkac from <a href="https://github.com/nxskok/mkac">Github</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">devtools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"nxskok/mkac"</span>)</a></code></pre></div>
</div>
<div id="packages-for-examples-below" class="section level2">
<h2 class="hasAnchor">
<a href="#packages-for-examples-below" class="anchor"></a>Packages (for examples below)</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#&gt; ── Attaching packages ────────────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.2.1 ──</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#&gt; ✔ ggplot2 3.1.1          ✔ purrr   0.3.2     </span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">#&gt; ✔ tibble  2.1.1          ✔ dplyr   0.8.0.1   </span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#&gt; ✔ tidyr   0.8.3.9000     ✔ stringr 1.4.0     </span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt; ✔ readr   1.3.1          ✔ forcats 0.3.0</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt; ── Conflicts ───────────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">#&gt; ✖ dplyr::filter() masks stats::filter()</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co">#&gt; ✖ dplyr::lag()    masks stats::lag()</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(mkac)</a></code></pre></div>
</div>
<div id="time-trends" class="section level2">
<h2 class="hasAnchor">
<a href="#time-trends" class="anchor"></a>Time trends</h2>
<p>This package facilitates the investigation of two basic problems in the analysis of data collected over time:</p>
<ol style="list-style-type: decimal">
<li>Is there a time trend at all (beyond chance)?</li>
<li>If there is a time trend, how big is it?</li>
</ol>
</div>
<div id="the-mann-kendall-correlation" class="section level2">
<h2 class="hasAnchor">
<a href="#the-mann-kendall-correlation" class="anchor"></a>The Mann-Kendall correlation</h2>
<p>The first question is attacked using the Mann-Kendall correlation, which is the Kendall correlation where the <span class="math inline">\(x\)</span>-variable is time. This is a non-parametric correlation that does not assume linearity and is not damaged by outliers. See <a href="https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient">this Wikipedia page</a> for details. It will thus detect non-linear but monotonic trends.</p>
<p>The Mann-Kendall correlation is based on the idea of “concordant” and “discordant” pairs. Suppose the variable measured over time is called y, and consider two values of y measured at different time points:</p>
<ul>
<li>if y is smaller for the earlier time point, the pair is called <strong>concordant</strong>;</li>
<li>if y is <em>larger</em> for the earlier time point, the pair is called <strong>discordant</strong>;</li>
<li>if the two values of y are the same, the pair is neither concordant nor discordant, and is ignored in the calculation of the Kendall correlation.</li>
</ul>
<p>The names reflect whether or not the pair of observations is in the same order as time; a concordant pair shows an “uphill” trend, and a discordant pair a “downhill” trend:</p>
<p><img src="reference/figures/README-unnamed-chunk-3-1.png" width="100%"></p>
<p>The Mann-Kendall correlation is then obtained by considering all possible pairs of observations, and counting up the total number of concordant and discordant ones. The difference concordant minus discordant is then scaled to lie between -1 and 1. There are n(n-1)/2 pairs of observations, and an outlier only contributes only n-1 concordances or discordances to the total, no matter how much of an outlier it is, so outliers can have only limited influence on the Mann-Kendall correlation.</p>
<p>If the values of y are independent, there is standard theory that enables us to test the null hypothesis that the Mann-Kendall correlation is zero. However, data that are collected over time are often autocorrelated. <a href="http://resolver.scholarsportal.info/resolve/00221694/v204i1-4/182_ammttfad">Hamed and Rao</a> obtain an approximation to the P-value of the Mann-Kendall test that applies when the observations are autocorrelated. The common case is of positive autocorrelation (when one value of y is high, the next value is more likely also to be high); the P-value for independent data is then <em>too low</em> and thus overstates the significance of the time trend. The Hamed-Rao adjustment is implemented in this package.</p>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>Consider world mean temperatures by year:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">my_url=<span class="st">"http://www.utsc.utoronto.ca/~butler/d29/temperature.csv"</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">temp=<span class="kw">read_csv</span>(my_url)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt; Warning: Missing column names filled in: 'X1' [1]</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; Parsed with column specification:</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt; cols(</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt;   X1 = col_double(),</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt;   Year = col_date(format = ""),</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt;   temperature = col_double(),</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt;   year = col_double()</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; )</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">temp</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; # A tibble: 131 x 4</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt;       X1 Year       temperature  year</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="co">#&gt;    &lt;dbl&gt; &lt;date&gt;           &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt;  1     1 1880-12-31        13.7  1880</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt;  2     2 1881-12-31        13.8  1881</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt;  3     3 1882-12-31        13.7  1882</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#&gt;  4     4 1883-12-31        13.7  1883</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">#&gt;  5     5 1884-12-31        13.7  1884</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="co">#&gt;  6     6 1885-12-31        13.7  1885</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co">#&gt;  7     7 1886-12-31        13.7  1886</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co">#&gt;  8     8 1887-12-31        13.6  1887</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co">#&gt;  9     9 1888-12-31        13.7  1888</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co">#&gt; 10    10 1889-12-31        13.8  1889</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#&gt; # … with 121 more rows</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="kw">ggplot</span>(temp, <span class="kw">aes</span>(<span class="dt">x=</span>year, <span class="dt">y=</span>temperature)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>()</a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co">#&gt; `geom_smooth()` using method = 'loess' and formula 'y ~ x'</span></a></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-4-1.png" width="100%"></p>
<p>This appears to show an upward trend, but with a lot of variability. Is that statistically significant?</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="reference/kendall_Z_adjusted.html">kendall_Z_adjusted</a></span>(temp<span class="op">$</span>temperature)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; $z</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#&gt; [1] 11.77267</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; $z_star</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt; [1] 4.475666</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt; $ratio</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt; [1] 6.918858</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; $P_value</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt; [1] 0</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#&gt; $P_value_adj</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt; [1] 7.617357e-06</span></a></code></pre></div>
<p>This says, for testing that the Mann-Kendall correlation is zero:</p>
<ul>
<li>Under the assumption of independent observations, the test statistic is z=11.77 with a P-value of zero.</li>
<li>Under the assumption of autocorrelated observations, the test statistic is z=4.48 with a P-value of 0.0000076.</li>
<li>The autocorrelation makes the “effective sample size” 6.91 times smaller.</li>
</ul>
<p>Because the temperatures are positively autocorrelated, the trend is strongly significant, but not as significant as it would be if the temperatures had been independent. I recommend using the adjusted P-value, but also looking at the effective sample size to see whether adjusting for autocorrelation actually made any difference.</p>
</div>
<div id="theil-sen-slope" class="section level2">
<h2 class="hasAnchor">
<a href="#theil-sen-slope" class="anchor"></a>Theil-Sen slope</h2>
<p>Having found a significant trend, the next question is “how big is it”? This can be answered by looking at the Theil-Sen slope. This assumes linearity (which should be checked for reasonableness), but is not affected by outliers.</p>
<p>The <strong>pairwise slope</strong> between two observations is the difference in their values of y divided by the difference in time between them. Each pair of points has a pairwise slope, and the Theil-Sen slope is the <em>median</em> of all possible pairwise slopes. Thus an outlier observation has <em>no</em> influence on the Theil-Sen slope (it can affect n-1 of the n(n-1)/2 pairwise slopes, but even if it does, it will not affect the median of them at all).</p>
<p>The world mean temperatures do not have a linear trend, but the Theil-Sen slope will give us some kind of average rate of change:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="reference/theil_sen_slope.html">theil_sen_slope</a></span>(temp<span class="op">$</span>temperature)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; [1] 0.005675676</span></a></code></pre></div>
<p>The trend appears to be approximately linear up to about 1970, and approximately linear after that, but with a steeper trend. We might calculate and compare two separate Theil-Sen slopes, thus:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">temp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">time_period=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(year<span class="op">&lt;=</span><span class="dv">1970</span>, <span class="st">"pre-1970"</span>, <span class="st">"post-1970"</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>time_period) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">theil_sen=</span><span class="kw">map_dbl</span>(data, <span class="op">~</span><span class="kw"><a href="reference/theil_sen_slope.html">theil_sen_slope</a></span>(.<span class="op">$</span>temperature)))</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt; # A tibble: 2 x 3</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt;   time_period data              theil_sen</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt;   &lt;chr&gt;       &lt;list&gt;                &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; 1 pre-1970    &lt;tibble [91 × 4]&gt;   0.00429</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; 2 post-1970   &lt;tibble [40 × 4]&gt;   0.0168</span></a></code></pre></div>
<p>Theil-Sen slope is very nearly <em>four times</em> as big since 1970 vs. before, and even then, appears to be increasing with time.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Ken Butler <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ken Butler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
